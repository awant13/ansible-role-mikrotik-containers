---
- name: Change registry for container
  community.routeros.api:
    hostname: "{{ inventory_hostname }}"
    username: "{{ mik_username }}"
    password: "{{ mik_password }}"
    path: container config
    cmd: "set registry-url={{ item.registry.url }}"
  when: item.registry is defined
  register: registry_result
  tags: container

- name: Add containers
  community.routeros.api:
    hostname: "{{ inventory_hostname }}"
    username: "{{ mik_username }}"
    password: "{{ mik_password }}"
    path: container
    cmd: >-
      add {{ container_commands[idx] }} 
      interface={{ container_net }}_{{ item.name }} 
      envlist={{ container_desc }}_{{ item.name}}_envs 
      comment={{ container_desc  }}_{{ item.name}}
      {% if item.mounts is defined and item.mounts | length > 0 %} 
      mounts={{ item.mounts | map(attribute='name') | join(',') }}
      {% endif %}
  # loop: "{{ containers }}"
  # loop_control:
  #   index_var: idx
  ignore_errors: yes
  register: result_add_container
  when: item.state == "present" and (containerId.results[idx].msg | default([]) | length == 0)
  changed_when: result_add_container.failed == false
  tags: container